package migrator;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.Reader;
import java.io.UnsupportedEncodingException;
import java.net.URISyntaxException;
import java.util.ArrayList;

import com.univocity.parsers.csv.CsvParser;
import com.univocity.parsers.csv.CsvParserSettings;

import mjson.Json;

public class CSVParser {

	public ArrayList<Json> parseDataToJson(Input input) 
			throws IOException {
		ArrayList<Json> items = new ArrayList<>();

		CsvParserSettings settings = new CsvParserSettings();
		settings.setLineSeparatorDetectionEnabled(true);
		CsvParser parser = new CsvParser(settings);
		parser.beginParsing(getReader(input.getDataPath() + ".csv"));

		String[] columns = parser.parseNext();
		String[] row;
		while ((row = parser.parseNext()) != null) {
			Json item = Json.object();
			for (int i = 0; i < row.length; i++) {
				item.set(columns[i], row[i]);
			}
			items.add(item);
		}
		return items;
	}

	Reader getReader(String relativePath) throws IOException {
		
		try {
			File[] files = new File(this.getClass().getResource("/").toURI()).listFiles();
			for (File file : files) {
				System.out.println(file.getAbsolutePath());
			}
		} catch (URISyntaxException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
				
		return new InputStreamReader(this.getClass().getResource("/src/main/resources" + relativePath).openStream(), "UTF-8");
	}

}
